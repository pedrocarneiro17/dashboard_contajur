<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Financeiro</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .chart-container { position: relative; height: 40vh; width: 100%; }
        body { display: flex; }
        aside { flex-shrink: 0; }
        main { flex-grow: 1; overflow-y: auto; height: 100vh; }
    </style>
</head>
<body class="bg-gray-200 font-sans">

    <aside class="w-64 bg-gray-800 text-white p-6 flex flex-col">
        <h1 class="text-2xl font-bold mb-8 text-center">Análise Financeira</h1>
        <form method="post" action="{{ url_for('dashboard') }}" enctype="multipart/form-data" class="mb-8 border-b border-gray-700 pb-8">
            <label for="file-upload" class="block text-sm font-medium text-gray-300 mb-2">Enviar Relatório</label>
            <input type="file" name="file" id="file-upload" accept=".xlsx" class="block w-full text-sm text-gray-400 file:mr-2 file:py-1 file:px-2 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 mb-2">
            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Enviar</button>
        </form>
        <nav class="flex-grow">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-sm font-semibold text-gray-400 uppercase tracking-wider">Relatórios Salvos</h2>
                <button id="selectAllBtn" class="text-xs bg-gray-600 hover:bg-gray-500 px-2 py-1 rounded">Selecionar Todos</button>
            </div>
            <ul>
                {% for m in months %}
                    <li class="my-1 flex items-center justify-between p-2 rounded-md hover:bg-gray-700">
                        <label class="flex items-center flex-grow cursor-pointer">
                            <input type="checkbox" name="month" value="{{ m }}" form="compareForm"
                                   class="month-checkbox h-4 w-4 rounded bg-gray-600 border-gray-500 text-blue-500 focus:ring-blue-400 mr-3">
                            <a href="{{ url_for('dashboard', month=m) }}" class="flex-grow {% if m == selected_month %}font-bold text-white{% else %}text-gray-300{% endif %}">{{ m }}</a>
                        </label>
                        <form action="{{ url_for('delete_month', month=m) }}" method="post" class="ml-2" onsubmit="return confirm('Tem certeza que deseja excluir os dados do mês {{ m }}?');">
                            <button type="submit" class="text-gray-500 hover:text-red-500" title="Excluir mês">&#x1F5D1;</button>
                        </form>
                    </li>
                {% else %}
                    <li class="px-4 py-2 text-gray-500">Nenhum relatório salvo.</li>
                {% endfor %}
            </ul>
            {% if months|length >= 2 %}
            <form action="{{ url_for('compare') }}" method="GET" id="compareForm">
                <button type="submit" id="compareButton" class="w-full mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>
                    Comparar Meses
                </button>
            </form>
            {% endif %}
        </nav>
    </aside>

    <main class="p-8">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="p-4 mb-4 text-sm rounded-lg {% if category == 'error' %} bg-red-100 text-red-700 {% else %} bg-green-100 text-green-700 {% endif %}" role="alert">
                        <span class="font-medium">{{ message }}</span>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        {% if error %}
            <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6" role="alert">
                <p class="font-bold">Erro no Upload</p>
                <p>{{ error }}</p>
            </div>
        {% endif %}

        {% if selected_month and totals %}
            <h1 class="text-3xl font-bold text-gray-800 mb-4">Dashboard de Resultados: {{ selected_month }}</h1>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-lg"><h3 class="text-sm font-semibold text-gray-500 uppercase">Receita Total</h3><p class="text-3xl font-bold text-green-600 mt-2">R$ <span class="money">{{ totals.total_revenue }}</span></p></div>
                <div class="bg-white p-6 rounded-xl shadow-lg"><h3 class="text-sm font-semibold text-gray-500 uppercase">Receita em Salários Mínimos</h3><p class="text-3xl font-bold text-blue-600 mt-2"><span class="money-count">{{ revenue_in_mw }}</span></p></div>
                <div class="bg-white p-6 rounded-xl shadow-lg"><h3 class="text-sm font-semibold text-gray-500 uppercase">Despesa Operacional</h3><p class="text-3xl font-bold text-red-600 mt-2">R$ <span class="money">{{ totals.total_expenses }}</span></p></div>
                <div class="bg-white p-6 rounded-xl shadow-lg"><h3 class="text-sm font-semibold text-gray-500 uppercase">Lucro Líquido</h3><p class="text-3xl font-bold text-indigo-600 mt-2">R$ <span class="money">{{ totals.net_profit }}</span></p></div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Gerenciar Retiradas</h2>
                <form action="{{ url_for('add_withdrawal') }}" method="post" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end border-b pb-4 mb-4">
                    <input type="hidden" name="month" value="{{ selected_month }}">
                    <div><label for="person" class="block text-sm font-medium text-gray-700">Pessoa</label><select id="person" name="person" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"><option>Lucas</option><option>Thiago</option><option>Ronaldo</option></select></div>
                    <div><label for="amount" class="block text-sm font-medium text-gray-700">Valor (R$)</label><input type="number" step="0.01" name="amount" id="amount" required class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></div>
                    <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md">Adicionar Retirada</button>
                </form>
                <h3 class="text-lg font-medium text-gray-800 mb-2 mt-4">Retiradas do Mês</h3>
                <ul class="space-y-2">
                    {% for w in withdrawals_list %}
                    <li class="flex justify-between items-center p-2 rounded-md {% if w.source == 'excel' %} bg-gray-100 {% else %} bg-blue-50 {% endif %}">
                        <div><span class="font-semibold">{{ w.person }}</span> - <span class="text-gray-800">R$ <span class="money">{{ "%.2f"|format(w.amount) }}</span></span><span class="text-xs text-white rounded-full px-2 py-0.5 ml-2 {% if w.source == 'excel' %} bg-gray-500 {% else %} bg-blue-500 {% endif %}">{{ w.source }}</span></div>
                        {% if w.source == 'manual' %}
                        <form action="{{ url_for('delete_withdrawal', withdrawal_id=w.id) }}" method="post" onsubmit="return confirm('Excluir esta retirada?');"><button type="submit" class="text-red-500 hover:text-red-700 font-bold">Excluir</button></form>
                        {% endif %}
                    </li>
                    {% else %}
                    <li class="text-gray-500">Nenhuma retirada registrada para este mês.</li>
                    {% endfor %}
                </ul>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Distribuição do Lucro</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="bg-blue-100 p-4 rounded-lg">
                        <h4 class="font-bold text-blue-800">Saldo Lucas</h4>
                        <p class="text-2xl font-light text-blue-900">R$ <span class="money">{{ totals.share_lucas }}</span></p>
                    </div>
                    <div class="bg-green-100 p-4 rounded-lg">
                        <h4 class="font-bold text-green-800">Saldo Thiago</h4>
                        <p class="text-2xl font-light text-green-900">R$ <span class="money">{{ totals.share_thiago }}</span></p>
                    </div>
                    <div class="bg-purple-100 p-4 rounded-lg">
                        <h4 class="font-bold text-purple-800">Saldo Ronaldo</h4>
                        <p class="text-2xl font-light text-purple-900">R$ <span class="money">{{ totals.share_ronaldo }}</span></p>
                    </div>
                     <div class="bg-gray-200 p-4 rounded-lg">
                        <h4 class="font-bold text-gray-800">Saldo Reserva</h4>
                        <p class="text-2xl font-light text-gray-900">R$ <span class="money">{{ totals.share_reserva }}</span></p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="bg-white p-6 rounded-lg shadow-md"><h2 class="text-xl font-semibold text-gray-700 mb-4">Resumo Geral</h2><div class="chart-container"><canvas id="summaryChart"></canvas></div></div>
                <div class="bg-white p-6 rounded-lg shadow-md"><h2 class="text-xl font-semibold text-gray-700 mb-4">Despesas por Categoria</h2><div class="chart-container"><canvas id="categoriesChart"></canvas></div></div>
            </div>
            {% if top_10_chart_data %}
            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Top 10 Despesas Operacionais</h2><div class="chart-container" style="height: 50vh;"><canvas id="top10ExpensesChart"></canvas></div>
            </div>
            {% endif %}
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Detalhamento das Despesas</h2>
            {% for category, items in expenses.items() %}
                <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">{{ category }}</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-center">
                        <div class="chart-container"><canvas id="expensesChart{{ loop.index }}"></canvas></div>
                        <div>
                            <table class="w-full text-left border-collapse">
                                <thead><tr><th class="py-2 px-3 bg-gray-200 font-bold uppercase text-sm text-gray-600 border-b">Subcategoria</th><th class="py-2 px-3 bg-gray-200 font-bold uppercase text-sm text-gray-600 border-b text-right">Valor (R$)</th><th class="py-2 px-3 bg-gray-200 font-bold uppercase text-sm text-gray-600 border-b text-right">(%)</th></tr></thead>
                                <tbody>
                                    {% for item in items %}<tr class="hover:bg-gray-100"><td class="py-2 px-3 border-b border-gray-200">{{ item.subcategory }}</td><td class="py-2 px-3 border-b border-gray-200 text-right money">{{ item.amount }}</td><td class="py-2 px-3 border-b border-gray-200 text-right text-gray-600">{{ "%.2f"|format(item.percentage) }}%</td></tr>{% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
             <div class="text-center py-16 bg-white rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold text-gray-600">Bem-vindo!</h2><p class="text-gray-500 mt-2">Para começar, envie um arquivo de relatório usando o menu à esquerda.</p>
            </div>
        {% endif %}
    </main>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const compareForm = document.getElementById('compareForm');
        const selectAllBtn = document.getElementById('selectAllBtn');
        const checkboxes = document.querySelectorAll('.month-checkbox');
        const compareButton = document.getElementById('compareButton');

        // Função para verificar a contagem de checkboxes selecionados e atualizar o botão
        const checkSelectedCount = () => {
            if (!checkboxes || !compareButton) return;
            const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            compareButton.disabled = checkedCount < 2;
        };

        // Adiciona evento de mudança a cada checkbox individualmente
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                checkSelectedCount();
            });
        });

        // Adiciona evento para o botão "Selecionar Todos"
        if (selectAllBtn && checkboxes.length > 0) {
            selectAllBtn.addEventListener('click', () => {
                const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                checkboxes.forEach(cb => {
                    cb.checked = !allChecked;
                    // Dispara o evento de mudança para cada checkbox
                    const event = new Event('change', { bubbles: true });
                    cb.dispatchEvent(event);
                });
                selectAllBtn.textContent = allChecked ? 'Selecionar Todos' : 'Limpar Seleção';
                checkSelectedCount(); // Verifica o estado do botão após a mudança
            });
        }

        // Garante que o formulário seja enviado ao clicar em "Comparar Meses"
        if (compareButton) {
            compareButton.addEventListener('click', (e) => {
                e.preventDefault(); // Evita comportamento padrão para garantir controle
                if (!compareButton.disabled) {
                    compareForm.submit(); // Submete o formulário
                }
            });
        }

        // Executa a verificação inicial
        checkSelectedCount();

        // Formatação de valores monetários
        const totals = {{ totals | tojson | safe }};
        const expenses = {{ expenses | tojson | safe }};
        const top10Data = {{ top_10_chart_data | tojson | safe }};

        if (!totals) return;

        const formatMoney = (value) => {
            const number = Number(value) || 0;
            return number.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        };

        document.querySelectorAll('.money').forEach(el => el.textContent = formatMoney(el.textContent));
        document.querySelectorAll('.money-count').forEach(el => el.textContent = formatMoney(el.textContent));

        const chartColors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#6366F1', '#D946EF', '#06B6D4', '#F97316', '#EC4899'];

        // Plugin para texto no centro do doughnut
        const doughnutText = {
            id: 'doughnutText',
            beforeDraw(chart) {
                if (chart.options.plugins.doughnutText && chart.options.plugins.doughnutText.display) {
                    const { ctx, chartArea: { width, height } } = chart;
                    ctx.save();
                    ctx.font = chart.options.plugins.doughnutText.font || 'bold 1rem sans-serif';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillStyle = '#000';
                    ctx.fillText(chart.options.plugins.doughnutText.text, width / 2, height / 2);
                    ctx.restore();
                }
            }
        };
        Chart.register(doughnutText);

        // Gráfico de Top 10 Despesas
        if (document.getElementById('top10ExpensesChart') && top10Data) {
            new Chart(document.getElementById('top10ExpensesChart').getContext('2d'), {
                type: 'bar',
                data: { labels: top10Data.labels, datasets: [{ label: 'Valor Gasto', data: top10Data.data, backgroundColor: '#3B82F6' }] },
                options: { 
                    indexAxis: 'y', 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { display: false }, 
                        tooltip: { callbacks: { label: (context) => `R$ ${formatMoney(context.raw)}` } } 
                    }, 
                    scales: { x: { ticks: { callback: (value) => `R$ ${formatMoney(value)}` } } } 
                }
            });
        }

        // Gráfico de Resumo Geral
        if (document.getElementById('summaryChart')) {
            new Chart(document.getElementById('summaryChart').getContext('2d'), {
                type: 'bar',
                data: { 
                    labels: ['Receitas', 'Despesas', 'Lucro Líquido'], 
                    datasets: [{ data: [totals.total_revenue, totals.total_expenses, totals.net_profit], backgroundColor: ['#10B981', '#EF4444', '#3B82F6'] }] 
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { display: false }, 
                        tooltip: { callbacks: { label: (context) => `R$ ${formatMoney(context.raw)}` } } 
                    }, 
                    scales: { y: { ticks: { callback: (value) => `R$ ${formatMoney(value)}` } } } 
                }
            });
        }

        // Gráfico de Despesas por Categoria
        if (document.getElementById('categoriesChart') && expenses) {
            const categoryLabels = Object.keys(expenses);
            const categoryData = categoryLabels.map(cat => expenses[cat].reduce((sum, item) => sum + item.amount, 0));
            new Chart(document.getElementById('categoriesChart').getContext('2d'), {
                type: 'doughnut',
                data: { labels: categoryLabels, datasets: [{ data: categoryData, backgroundColor: chartColors }] },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { position: 'right' }, 
                        tooltip: { callbacks: { label: (context) => `${context.label}: R$ ${formatMoney(context.raw)}` } } 
                    } 
                }
            });
        }

        // Gráficos de Detalhamento de Despesas por Categoria
        if (expenses) {
            Object.keys(expenses).forEach((category, index) => {
                const canvasId = `expensesChart${index + 1}`;
                const detailCtx = document.getElementById(canvasId);
                if (detailCtx) {
                    const items = expenses[category];
                    const labels = items.map(item => item.subcategory);
                    const data = items.map(item => item.amount);
                    const totalAmount = data.reduce((sum, val) => sum + val, 0);
                    new Chart(detailCtx.getContext('2d'), {
                        type: 'doughnut',
                        data: { labels: labels, datasets: [{ data: data, backgroundColor: chartColors }] },
                        options: { 
                            responsive: true, 
                            maintainAspectRatio: false, 
                            plugins: { 
                                legend: { display: false }, 
                                tooltip: { callbacks: { label: (context) => `${context.label}: R$ ${formatMoney(context.raw)}` } }, 
                                doughnutText: { display: true, text: `R$ ${formatMoney(totalAmount)}`, font: 'bold 1.2rem sans-serif' } 
                            } 
                        }
                    });
                }
            });
        }
    });
    </script>
</body>
</html>
    