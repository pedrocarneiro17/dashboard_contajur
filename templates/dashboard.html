<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Financeiro</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .chart-container { position: relative; height: 40vh; width: 100%; }
        body { display: flex; }
        aside { flex-shrink: 0; }
        main { flex-grow: 1; overflow-y: auto; height: 100vh; }
    </style>
</head>
<body class="bg-gray-200 font-sans">

    <aside class="w-64 bg-gray-800 text-white p-6 flex flex-col">
        <h1 class="text-2xl font-bold mb-8 text-center">Análise Financeira Contajur</h1>

        <form method="post" action="{{ url_for('dashboard') }}" enctype="multipart/form-data" class="mb-8 border-b border-gray-700 pb-8">
            <label for="file-upload" class="block text-sm font-medium text-gray-300 mb-2">Enviar Relatório</label>
            <input type="file" name="file" id="file-upload" accept=".xlsx" class="block w-full text-sm text-gray-400 file:mr-2 file:py-1 file:px-2 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 mb-2">
            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Enviar</button>
        </form>

        <nav class="flex-grow">
            <h2 class="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-4">Relatórios Salvos</h2>
            <form action="{{ url_for('compare') }}" method="GET" id="compareForm">
                <ul>
                    {% for m in months %}
                        <li class="my-1">
                            <label class="flex items-center p-2 rounded-md hover:bg-gray-700 cursor-pointer">
                                <input type="checkbox" name="month" value="{{ m }}" class="h-4 w-4 rounded bg-gray-600 border-gray-500 text-blue-500 focus:ring-blue-400 mr-3">
                                <a href="{{ url_for('dashboard', month=m) }}" class="flex-grow {% if m == selected_month %}font-bold text-white{% else %}text-gray-300{% endif %}">{{ m }}</a>
                            </label>
                        </li>
                    {% else %}
                        <li class="px-4 py-2 text-gray-500">Nenhum relatório salvo.</li>
                    {% endfor %}
                </ul>
                {% if months|length >= 2 %}
                <button type="submit" id="compareButton" class="w-full mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>
                    Comparar Meses
                </button>
                {% endif %}
            </form>
        </nav>
    </aside>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('compareForm');
            if (form) {
                const checkboxes = form.querySelectorAll('input[type="checkbox"]');
                const compareButton = document.getElementById('compareButton');

                form.addEventListener('change', () => {
                    const checkedCount = Array.from(checkboxes).filter(i => i.checked).length;
                    compareButton.disabled = checkedCount < 2;
                });
            }
        });
    </script>

    <main class="p-8">
        {% if selected_month and totals and expenses %}
            <h1 class="text-3xl font-bold text-gray-800 mb-6">Dashboard de Resultados: {{ selected_month }}</h1>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="bg-white p-6 rounded-lg shadow-md"><h2 class="text-xl font-semibold text-gray-700 mb-4">Resumo Geral</h2><div class="chart-container"><canvas id="summaryChart"></canvas></div></div>
                <div class="bg-white p-6 rounded-lg shadow-md"><h2 class="text-xl font-semibold text-gray-700 mb-4">Despesas por Categoria</h2><div class="chart-container"><canvas id="categoriesChart"></canvas></div></div>
            </div>

            <h2 class="text-2xl font-bold text-gray-800 mb-6">Detalhamento das Despesas</h2>
            {% for category, items in expenses.items() %}
                <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">{{ category }}</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-center">
                        <div class="chart-container"><canvas id="expensesChart{{ loop.index }}"></canvas></div>
                        <div>
                            <table class="w-full text-left border-collapse">
                                <thead><tr><th class="py-2 px-3 bg-gray-200 font-bold uppercase text-sm text-gray-600 border-b">Subcategoria</th><th class="py-2 px-3 bg-gray-200 font-bold uppercase text-sm text-gray-600 border-b text-right">Valor (R$)</th></tr></thead>
                                <tbody>
                                    {% for item in items %}
                                        <tr class="hover:bg-gray-100"><td class="py-2 px-3 border-b border-gray-200">{{ item.subcategory }}</td><td class="py-2 px-3 border-b border-gray-200 text-right">{{ "%.2f"|format(item.amount) }}</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
             <div class="text-center py-16 bg-white rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold text-gray-600">Bem-vindo!</h2>
                <p class="text-gray-500 mt-2">Para começar, envie um arquivo de relatório usando o menu à esquerda.</p>
            </div>
        {% endif %}
    </main>

    <script>
        // ... (o script que desenha os gráficos para um único mês continua aqui) ...
        document.addEventListener('DOMContentLoaded', function () {
            // CORREÇÃO CRÍTICA: Adicionado o filtro |safe para passar o JSON corretamente
            const totals = {{ totals | tojson | safe }};
            const expenses = {{ expenses | tojson | safe }};

            if (!totals || !expenses) return; // Não faz nada se não houver dados

            const chartColors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#6366F1', '#D946EF', '#06B6D4', '#F97316', '#EC4899'];
            const formatCurrency = (value) => value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

            const doughnutText = {
                id: 'doughnutText',
                beforeDraw: (chart) => {
                    if (chart.config.options.plugins.doughnutText?.display) {
                        const { ctx } = chart;
                        const { text, font, color } = chart.config.options.plugins.doughnutText;
                        ctx.save();
                        const x = chart.getDatasetMeta(0).data[0].x;
                        const y = chart.getDatasetMeta(0).data[0].y;
                        ctx.font = font || 'bold 20px sans-serif';
                        ctx.fillStyle = color ||'#4B5563';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(text, x, y);
                        ctx.restore();
                    }
                }
            };
            Chart.register(doughnutText);

            // --- Gráfico 1: Resumo Financeiro (Barras) ---
            const summaryCtx = document.getElementById('summaryChart');
            if (summaryCtx) {
                new Chart(summaryCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ['Receitas', 'Despesas', 'Lucro Líquido'],
                        datasets: [{ data: [totals.total_revenue, totals.total_expenses, totals.net_profit], backgroundColor: ['#10B981', '#EF4444', '#3B82F6'] }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { ticks: { callback: (value) => formatCurrency(value) } } }
                    }
                });
            }

            // --- Gráfico 2: Despesas por Categoria (Rosca) ---
            const categoriesCtx = document.getElementById('categoriesChart');
            if (categoriesCtx) {
                const categoryLabels = Object.keys(expenses);
                const categoryData = categoryLabels.map(cat => expenses[cat].reduce((sum, item) => sum + item.amount, 0));
                new Chart(categoriesCtx.getContext('2d'), {
                    type: 'doughnut',
                    data: { labels: categoryLabels, datasets: [{ data: categoryData, backgroundColor: chartColors }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
                });
            }

            // --- Gráficos 3: Detalhamento por Categoria (Rosca) ---
            Object.keys(expenses).forEach((category, index) => {
                const canvasId = `expensesChart${index + 1}`;
                const detailCtx = document.getElementById(canvasId);
                if(detailCtx) {
                    const items = expenses[category];
                    const labels = items.map(item => item.subcategory);
                    const data = items.map(item => item.amount);
                    const totalAmount = data.reduce((sum, val) => sum + val, 0);

                    new Chart(detailCtx.getContext('2d'), {
                        type: 'doughnut',
                        data: { labels: labels, datasets: [{ data: data, backgroundColor: chartColors }] },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: { callbacks: { label: (context) => `${context.label}: ${formatCurrency(context.raw)}` } },
                                doughnutText: { display: true, text: formatCurrency(totalAmount), font: 'bold 1.2rem sans-serif' }
                            }
                        }
                    });
                }
            });
        });
    </script>
</body>
</html>