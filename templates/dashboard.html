<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Financeiro</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .chart-container { position: relative; height: 40vh; width: 100%; }
        body { display: flex; }
        aside { flex-shrink: 0; }
        main { flex-grow: 1; overflow-y: auto; height: 100vh; }
    </style>
</head>
<body class="bg-gray-200 font-sans">

    <aside class="w-64 bg-gray-800 text-white p-6 flex flex-col">
        <h1 class="text-2xl font-bold mb-8 text-center">Análise Financeira</h1>

        <form method="post" action="{{ url_for('dashboard') }}" enctype="multipart/form-data" class="mb-8 border-b border-gray-700 pb-8">
            <label for="file-upload" class="block text-sm font-medium text-gray-300 mb-2">Enviar Relatório</label>
            <input type="file" name="file" id="file-upload" accept=".xlsx" class="block w-full text-sm text-gray-400 file:mr-2 file:py-1 file:px-2 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 mb-2">
            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Enviar</button>
        </form>

        <nav class="flex-grow">
            <h2 class="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-4">Relatórios Salvos</h2>
            <ul>
                {% for m in months %}
                    <li class="my-1 flex items-center justify-between p-2 rounded-md hover:bg-gray-700">
                        <label class="flex items-center flex-grow cursor-pointer">
                            <input type="checkbox" name="month" value="{{ m }}" form="compareForm"
                                   class="h-4 w-4 rounded bg-gray-600 border-gray-500 text-blue-500 focus:ring-blue-400 mr-3">
                            <a href="{{ url_for('dashboard', month=m) }}" class="flex-grow {% if m == selected_month %}font-bold text-white{% else %}text-gray-300{% endif %}">{{ m }}</a>
                        </label>
                        <form action="{{ url_for('delete_month', month=m) }}" method="post" class="ml-2" 
                              onsubmit="return confirm('Tem certeza que deseja excluir todos os dados do mês {{ m }}? Esta ação não pode ser desfeita.');">
                            <button type="submit" class="text-gray-500 hover:text-red-500" title="Excluir mês">&#x1F5D1;</button>
                        </form>
                    </li>
                {% else %}
                    <li class="px-4 py-2 text-gray-500">Nenhum relatório salvo.</li>
                {% endfor %}
            </ul>

            {% if months|length >= 2 %}
            <form action="{{ url_for('compare') }}" method="GET" id="compareForm">
                <button type="submit" id="compareButton" class="w-full mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>
                    Comparar Meses
                </button>
            </form>
            {% endif %}
        </nav>
    </aside>

    <main class="p-8">
        {% if error %}
            <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6" role="alert">
                <p class="font-bold">Erro no Upload</p>
                <p>{{ error }}</p>
            </div>
        {% endif %}

        {% if selected_month and totals and expenses %}
            <h1 class="text-3xl font-bold text-gray-800 mb-4">Dashboard de Resultados: {{ selected_month }}</h1>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-lg flex flex-col justify-between">
                    <h3 class="text-sm font-semibold text-gray-500 uppercase">Receita Total</h3>
                    <p class="text-3xl font-bold text-green-600 mt-2">R$ <span class="money">{{ totals.total_revenue }}</span></p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg flex flex-col justify-between">
                    <h3 class="text-sm font-semibold text-gray-500 uppercase">Receita em Salários Mínimos</h3>
                    <p class="text-3xl font-bold text-blue-600 mt-2"><span class="money-count">{{ revenue_in_mw }}</span></p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg flex flex-col justify-between">
                    <h3 class="text-sm font-semibold text-gray-500 uppercase">Despesa Total</h3>
                    <p class="text-3xl font-bold text-red-600 mt-2">R$ <span class="money">{{ totals.total_expenses }}</span></p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg flex flex-col justify-between">
                    <h3 class="text-sm font-semibold text-gray-500 uppercase">Lucro Líquido</h3>
                    <p class="text-3xl font-bold text-indigo-600 mt-2">R$ <span class="money">{{ totals.net_profit }}</span></p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="bg-white p-6 rounded-lg shadow-md"><h2 class="text-xl font-semibold text-gray-700 mb-4">Resumo Geral</h2><div class="chart-container"><canvas id="summaryChart"></canvas></div></div>
                <div class="bg-white p-6 rounded-lg shadow-md"><h2 class="text-xl font-semibold text-gray-700 mb-4">Despesas por Categoria</h2><div class="chart-container"><canvas id="categoriesChart"></canvas></div></div>
            </div>
            
            {% if top_10_chart_data %}
            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Top 10 Despesas do Mês</h2>
                <div class="chart-container" style="height: 50vh;">
                    <canvas id="top10ExpensesChart"></canvas>
                </div>
            </div>
            {% endif %}

            <h2 class="text-2xl font-bold text-gray-800 mb-6">Detalhamento das Despesas</h2>
            {% for category, items in expenses.items() %}
                <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">{{ category }}</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-center">
                        <div class="chart-container"><canvas id="expensesChart{{ loop.index }}"></canvas></div>
                        <div>
                            <table class="w-full text-left border-collapse">
                                <thead>
                                    <tr>
                                        <th class="py-2 px-3 bg-gray-200 font-bold uppercase text-sm text-gray-600 border-b">Subcategoria</th>
                                        <th class="py-2 px-3 bg-gray-200 font-bold uppercase text-sm text-gray-600 border-b text-right">Valor (R$)</th>
                                        <th class="py-2 px-3 bg-gray-200 font-bold uppercase text-sm text-gray-600 border-b text-right">(%)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in items %}
                                        <tr class="hover:bg-gray-100">
                                            <td class="py-2 px-3 border-b border-gray-200">{{ item.subcategory }}</td>
                                            <td class="py-2 px-3 border-b border-gray-200 text-right money">{{ item.amount }}</td>
                                            <td class="py-2 px-3 border-b border-gray-200 text-right text-gray-600">{{ "%.2f"|format(item.percentage) }}%</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
             <div class="text-center py-16 bg-white rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold text-gray-600">Bem-vindo!</h2>
                <p class="text-gray-500 mt-2">Para começar, envie um arquivo de relatório usando o menu à esquerda.</p>
            </div>
        {% endif %}
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Lógica do botão de comparar
            const compareForm = document.getElementById('compareForm');
            if (compareForm) {
                const checkboxes = document.querySelectorAll('input[name="month"][form="compareForm"]');
                const compareButton = document.getElementById('compareButton');
                const checkSelectedCount = () => {
                    const checkedCount = Array.from(checkboxes).filter(i => i.checked).length;
                    if(compareButton) { compareButton.disabled = checkedCount < 2; }
                };
                document.querySelector('aside').addEventListener('change', checkSelectedCount);
                checkSelectedCount();
            }

            // Pega os dados do Flask
            const totals = {{ totals | tojson | safe }};
            const expenses = {{ expenses | tojson | safe }};
            const top10Data = {{ top_10_chart_data | tojson | safe }};

            if (!totals || !expenses) return; 

            // --- FUNÇÃO CENTRAL DE FORMATAÇÃO ---
            const formatMoney = (value) => {
                const number = Number(value) || 0;
                return number.toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            };

            // Formata todos os elementos HTML com a classe 'money' ou 'money-count'
            document.querySelectorAll('.money').forEach(el => el.textContent = formatMoney(el.textContent));
            document.querySelectorAll('.money-count').forEach(el => el.textContent = formatMoney(el.textContent));
            
            const chartColors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#6366F1', '#D946EF', '#06B6D4', '#F97316', '#EC4899'];

            const doughnutText = {
                id: 'doughnutText',
                beforeDraw: (chart) => {
                    if (chart.config.options.plugins.doughnutText?.display) {
                        const { ctx } = chart;
                        const { text, font, color } = chart.config.options.plugins.doughnutText;
                        ctx.save();
                        const x = chart.getDatasetMeta(0).data[0].x;
                        const y = chart.getDatasetMeta(0).data[0].y;
                        ctx.font = font || 'bold 20px sans-serif';
                        ctx.fillStyle = color ||'#4B5563';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(text, x, y);
                        ctx.restore();
                    }
                }
            };
            Chart.register(doughnutText);

            // Gráfico Top 10 - usando a nova formatação
            const top10Ctx = document.getElementById('top10ExpensesChart');
            if(top10Ctx && top10Data) {
                new Chart(top10Ctx.getContext('2d'), {
                    type: 'bar',
                    data: { labels: top10Data.labels, datasets: [{ label: 'Valor Gasto', data: top10Data.data, backgroundColor: '#3B82F6' }] },
                    options: {
                        indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: { callbacks: { label: (context) => `R$ ${formatMoney(context.raw)}` } }
                        },
                        scales: { x: { ticks: { callback: (value) => `R$ ${formatMoney(value)}` } } }
                    }
                });
            }

            // Gráfico Resumo Geral - usando a nova formatação
            const summaryCtx = document.getElementById('summaryChart');
            if (summaryCtx) {
                new Chart(summaryCtx.getContext('2d'), {
                    type: 'bar',
                    data: { labels: ['Receitas', 'Despesas', 'Lucro Líquido'], datasets: [{ data: [totals.total_revenue, totals.total_expenses, totals.net_profit], backgroundColor: ['#10B981', '#EF4444', '#3B82F6'] }] },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: { callbacks: { label: (context) => `R$ ${formatMoney(context.raw)}` } }
                        },
                        scales: { y: { ticks: { callback: (value) => `R$ ${formatMoney(value)}` } } }
                    }
                });
            }

            // Gráfico Despesas por Categoria
            const categoriesCtx = document.getElementById('categoriesChart');
            if (categoriesCtx) {
                const categoryLabels = Object.keys(expenses);
                const categoryData = categoryLabels.map(cat => expenses[cat].reduce((sum, item) => sum + item.amount, 0));
                new Chart(categoriesCtx.getContext('2d'), {
                    type: 'doughnut',
                    data: { labels: categoryLabels, datasets: [{ data: categoryData, backgroundColor: chartColors }] },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'right' },
                            tooltip: { callbacks: { label: (context) => `${context.label}: R$ ${formatMoney(context.raw)}` } }
                        }
                    }
                });
            }

            // Gráficos Detalhamento - usando a nova formatação
            Object.keys(expenses).forEach((category, index) => {
                const canvasId = `expensesChart${index + 1}`;
                const detailCtx = document.getElementById(canvasId);
                if(detailCtx) {
                    const items = expenses[category];
                    const labels = items.map(item => item.subcategory);
                    const data = items.map(item => item.amount);
                    const totalAmount = data.reduce((sum, val) => sum + val, 0);
                    new Chart(detailCtx.getContext('2d'), {
                        type: 'doughnut',
                        data: { labels: labels, datasets: [{ data: data, backgroundColor: chartColors }] },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: { callbacks: { label: (context) => `${context.label}: R$ ${formatMoney(context.raw)}` } },
                                doughnutText: { display: true, text: `R$ ${formatMoney(totalAmount)}`, font: 'bold 1.2rem sans-serif' }
                            }
                        }
                    });
                }
            });
        });
    </script>
</body>
</html>